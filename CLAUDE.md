# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**transom-sequelize** is a TransomJS module that generates Sequelize models from SQL databases and automatically exposes CRUD operations via REST API endpoints. It introspects database schemas, generates metadata files, and creates REST routes with support for ACL (Access Control Lists), audit trails, and custom model methods/hooks.

**Important:** This module now works with transom-core 5.x which uses Express instead of Restify. Error handling uses `http-errors` (not `restify-errors`), and route registration uses Express's middleware pattern with `TransomCore.withMeta()` for metadata attachment.

## Development Commands

### Testing
```bash
npm test                    # Run all tests with coverage via nyc/mocha
cross-env NODE_ENV=test nyc mocha  # Explicit test command
```

### Coverage
```bash
npm run coveralls          # Generate and send coverage report to Coveralls
```

### Deployment
```bash
npm run deploy             # Release using np (interactive release tool)
```

## Architecture Overview

### Initialization Flow (index.js)

1. **Configuration Loading**: Reads `sequelize` definition from transom-config registry
2. **Database Connection**: Creates Sequelize instance with retry logic (up to 10 attempts)
3. **Metadata Generation**: Uses `SequelizeMeta` to introspect database and generate model metadata files
4. **Model Creation**: Creates Sequelize models with combined metadata (generated + user-defined)
5. **Route Setup**: Uses `SequelizeRoutes` to create REST endpoints for each table

### Key Components

#### lib/sequelize-meta.js
- Introspects database tables and generates metadata files
- Handles foreign keys, primary keys, and data type mapping
- Outputs metadata to `sequelize-metadata/` (or custom directory)
- Converts database types to Sequelize DataTypes
- Special handling for MSSQL DATE fields and Unicode strings

#### lib/sequelizeRoutes.js
- Creates standard REST routes for each table:
  - `POST /db/:entity` - Insert
  - `GET /db/:entity` - Find (with query parameters)
  - `GET /db/:entity/count` - Count records
  - `GET /db/:entity/:__id` - Find by ID
  - `PUT /db/:entity/:__id` - Update by ID
  - `DELETE /db/:entity` - Delete by query (disabled by default)
  - `DELETE /db/:entity/batch` - Batch delete
  - `DELETE /db/:entity/:__id` - Delete by ID
- Routes can be selectively enabled/disabled per table
- Supports API versioning via Accept-Version header

#### lib/modelHandler.js
- Request handlers that delegate to modelFunctions
- Handles response formatting and error handling
- Supports custom responder functions per route
- Scrubs ACL values from responses

#### lib/modelFunctions.js
- Core CRUD operations implementation
- Integrates with HandlerUtils for query building
- Integrates with HandlerAcl for access control
- Supports custom `nextVal()` static method for non-autoincrement PKs
- Adds audit fields (createdBy/updatedBy) from req.locals.user

#### lib/handlerUtils.js
- Query building from REST parameters
- Type coercion for primary keys
- Select field processing
- API operation separation (filters vs operations)

#### lib/handlerAcl.js
- ACL enforcement for find/insert/update/delete operations
- Applies ACL defaults on insert
- Filters queries based on user permissions

### Model Configuration

Models are defined in the transom-config `sequelize.tables` object with:

- **attributes**: Override generated metadata, set `queryable: false` to exclude from queries
- **methods**: Instance methods (do NOT use arrow functions, need `this` context)
- **statics**: Class-level methods, including optional `nextVal()` for custom PK generation
- **hooks**: Sequelize lifecycle hooks (afterFind, beforeCreate, etc.)
- **routes**: Enable/disable specific CRUD routes per table
- **acl**: Access control configuration (requires `needsAcl: true`)
- **audit**: Audit trail configuration with custom field names (createdAt, updatedAt, createdBy, updatedBy)

### Generated Metadata

- Metadata files are JavaScript modules exporting column definitions
- Located in `sequelize-metadata/` by default (configurable via `directory` option)
- Generated files are marked with warning header: "Do not modify by hand"
- Column names are camelCased by default
- Can be regenerated by setting `overwrite: true` (recommended for development only)

### Dialect Support

Supported databases (lib/dialects/):
- MySQL/MariaDB
- PostgreSQL
- MSSQL (with special handling for BIT types and DATE formatting)
- SQLite

## Important Implementation Notes

### Model Methods and Hooks
- **NEVER use arrow functions** for instance methods or hooks - they lose `this` context
- Use regular function syntax: `function() { return this.firstName; }`

### Audit Trail
- If `audit` is not explicitly set to `false`, timestamps are enabled
- User email from `req.locals.user.email` populates createdBy/updatedBy
- Defaults to "unknown" if no user context exists

### ACL Integration
- Set `acl` configuration on table definition to enable ACL
- ACL fields (aclOwner, aclGroup, aclGroupPrivs, aclPublicPrivs) are automatically scrubbed from responses
- HandlerAcl enforces permissions on all CRUD operations

### Primary Keys
- If table lacks auto-increment PK, define `primaryKey: true` in attributes
- For custom PK generation, implement static `nextVal()` method
- PK values are strongly typed based on column definition

### Date Handling
- MSSQL DATE fields get custom `_stringify` formatting
- DATEONLY fields get special getter that appends 'T00:00:00' for proper date parsing

### Route Customization
- Routes can be individually disabled by setting to `false` in routes config
- Delete by query is disabled by default (too dangerous)
- Custom route handlers can be provided via `fx` property
- Custom responders can be provided via `responder` property

## Registry Keys

- `sequelize` (or custom via `sequelizeKey`): Sequelize instance
- `transom-config.definition.sequelize`: Module configuration
- `transom-config.definition.uri.prefix`: API URI prefix for routes

## Test Structure

Tests are located in `test/` directory:
- `test/index.spec.js` - Main integration tests
- `test/handlerUtils.spec.js` - Handler utility tests
- `test/mssqlMeta.js` - MSSQL metadata test fixtures
